name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r ui/requirements-ui.txt
        pip install pytest ruff
    
    - name: Lint with ruff (critical rules only - blocking)
      run: |
        ruff check . --select E9,F63,F7,F82 --output-format=github
      # E9: Syntax errors, F63: print statements, F7: syntax errors in type annotations, F82: undefined names
    
    - name: Lint with ruff (all rules - non-blocking)
      run: |
        ruff check . --output-format=github
      continue-on-error: true  # Style warnings sind non-blocking
    
    - name: Format check with ruff (non-blocking)
      run: |
        ruff format --check .
      continue-on-error: true  # Format ist non-blocking
    
    - name: Run pytest
      run: |
        python -m pytest -q
      env:
        TEST_MODE: "1"
        NEO4J_ENABLED: "0"
        OPENAI_API_KEY: "test-key-not-used"
    
    - name: Check Readability Package
      run: |
        python scripts/check_readability_package.py
      continue-on-error: true  # Nicht kritisch, wenn Artefakte fehlen
      env:
        TEST_MODE: "1"
        NEO4J_ENABLED: "0"
    
    - name: Check Readability Status (deterministic with fixtures)
      run: |
        # Verwende Mini-Fixtures für deterministischen Check
        python scripts/build_readability_status.py \
          --agent_run_dir tests/fixtures/readability_run_mini \
          --baseline_matrix tests/fixtures/readability_baseline_matrix_mini.csv \
          --out /tmp/readability_status_generated.md \
          --check tests/fixtures/readability_status_expected.md || {
          echo "⚠ Check-Mode erfordert erwartete Datei (tests/fixtures/readability_status_expected.md)"
          echo "  Erstelle sie manuell oder überspringe Check in CI"
          exit 0
        }
      continue-on-error: true  # Nicht kritisch, wenn expected file fehlt
      env:
        TEST_MODE: "1"
        NEO4J_ENABLED: "0"
    
    - name: Verify Quality (Factuality/Coherence)
      run: |
        python scripts/verify_quality_factuality_coherence.py --use_fixture
      continue-on-error: true
      env:
        TEST_MODE: "1"
        NEO4J_ENABLED: "0"

